{%load static%}
<!DOCTYPE html>
<html>
<head>
    <title>Réservation de salle - Admin</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
   
</head>
<body>
    <h2>Gestion des réservations - Admin</h2>
    
    <!-- Bouton profil admin -->
    <button class="profile-button" onclick="goToProfilAdmin()">
        Profil Admin
    </button>

    <form id="reservationForm" method="POST" action="{% url 'blockSlotsAdmin' %}">
        {% csrf_token %}

        <label for="weekSelector">Sélectionner une semaine :</label>
        <select id="weekSelector">
            <!-- Les options pour les semaines seront générées par JavaScript -->
        </select>

        <table>
            <thead>
                <tr id="daysHeader">
                    <!-- Les en-têtes des jours seront générées ici par JavaScript -->
                </tr>
            </thead>
            <tbody id="timeSlotsTable">
                <!-- Les créneaux horaires avec les réservations seront générés ici par JavaScript -->
            </tbody>
        </table>
        <input type="hidden" name="selected_hours" id="selectedSlots">
        <label for="whichBox">Choisir la box à bloquer :</label>
        <select name="which_box" id="whichBox">
            <option value="1">Boîte 1</option>
            <option value="2">Boîte 2</option>
            <option value="1-2">Boîte 1 et 2</option>
        </select>
                <button type="submit" id="blockButton">Bloquer les créneaux sélectionnés</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timeSlotsTable = document.getElementById('timeSlotsTable');
            const selectedSlotsInput = document.getElementById('selectedSlots');
            const weekSelector = document.getElementById('weekSelector');
            const daysHeader = document.getElementById('daysHeader');
            const blockButton = document.getElementById('blockButton');
            let selectedSlots = new Set(); // Utiliser un Set pour stocker les créneaux sélectionnés
/*
            // Données simulées pour les réservations (à remplacer par des données de la base de données)
            const reservations = [
                { date: '2025-01-24', time: '09:00', student: 'E12345' },
                { date: '2025-01-25', time: '10:00', student: 'E67890' },
            ];

            // Données simulées pour les créneaux bloqués (à remplacer par des données de la base de données)
            let blocked_slots = [
                { date: '2025-01-24', time: '14:00' },
            ];
*/
            // Générer dynamiquement les options du sélecteur de semaine
            function generateWeekOptions() {
                const currentDate = new Date();
                const currentDay = currentDate.getDay();
                const daysUntilMonday = (currentDay + 6) % 7;
                currentDate.setDate(currentDate.getDate() - daysUntilMonday); // Se déplacer au lundi de la semaine actuelle

                for (let i = 0; i <= 5; i++) {
                    const option = document.createElement('option');
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(startOfWeek.getDate() + i * 7);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 4); // Jusqu'à vendredi

                    const startStr = `${startOfWeek.getDate()} ${startOfWeek.toLocaleString('default', { month: 'short' })} ${startOfWeek.getFullYear()}`;
                    const endStr = `${endOfWeek.getDate()} ${endOfWeek.toLocaleString('default', { month: 'short' })} ${endOfWeek.getFullYear()}`;
                    option.value = startOfWeek.toISOString().split('T')[0];
                    option.textContent = `${startStr} - ${endStr}`;
                    weekSelector.appendChild(option);
                }
            }

            // Générer dynamiquement les en-têtes de jours avec dates
            function generateDaysHeader(weekStart) {
                daysHeader.innerHTML = '';
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
                for (let i = 0; i < days.length; i++) {
                    const th = document.createElement('th');
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(currentDate.getDate() + i);
                    const dateStr = `${days[i]} ${currentDate.getDate()} ${currentDate.toLocaleString('default', { month: 'long' })}`;
                    th.textContent = dateStr;
                    daysHeader.appendChild(th);
                }
            }

            // Générer dynamiquement les créneaux horaires avec les réservations
            function generateTimeSlots(weekStart) {
                timeSlotsTable.innerHTML = '';
                const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
                for (let i = 9; i < 17; i++) {
                    const row = document.createElement('tr');
                    days.forEach((day, index) => {
                        const slotCell = document.createElement('td');
                        const currentDate = new Date(weekStart);
                        currentDate.setDate(currentDate.getDate() + index);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        const timeStr = `${i}:00`;

                        // Vérifier si le créneau est réservé
                        /*const reservation = reservations.find(res => res.date === dateStr && res.time === timeStr);
                        if (reservation) {
                            slotCell.classList.add('time-slot', 'reserved');
                            slotCell.textContent = `Réservé par ${reservation.student}`;
                        } else if (blocked_slots.find(slot => slot.date === dateStr && slot.time === timeStr)) {
                            slotCell.classList.add('time-slot', 'blocked');
                            slotCell.textContent = 'Bloqué';
                        } else {*/
                            slotCell.classList.add('time-slot');
                            slotCell.textContent = timeStr;
                        //}

                        slotCell.setAttribute('data-time', timeStr);
                        slotCell.setAttribute('data-day', day);
                        slotCell.setAttribute('data-date', dateStr);

                        // Vérifier si ce créneau est déjà sélectionné
                        if (selectedSlots.has(dateStr + ' ' + timeStr)) {
                            slotCell.classList.add('selected');
                        }

                        row.appendChild(slotCell);
                    });
                    timeSlotsTable.appendChild(row);
                }
            }

            // Gérer la sélection des créneaux horaires
            function handleTimeSlotSelection() {
                const timeSlots = document.querySelectorAll('.time-slot');
                timeSlots.forEach(slot => {
                    slot.addEventListener('click', function() {
                        // Ne pas permettre la sélection des créneaux réservés
                        if (slot.classList.contains('reserved')) {
                            return;
                        }

                        const date = slot.getAttribute('data-date');
                        const time = slot.getAttribute('data-time');
                        const slotKey = date + ' ' + time;

                        if (selectedSlots.has(slotKey)) {
                            // Désélectionner le créneau
                            selectedSlots.delete(slotKey);
                            slot.classList.remove('selected');
                        } else {
                            // Sélectionner le créneau
                            selectedSlots.add(slotKey);
                            slot.classList.add('selected');
                        }

                        updateSelectedSlots();
                    });
                });
            }

            function updateSelectedSlots() {
                selectedSlotsInput.value = Array.from(selectedSlots).join(',');
            }

            // Gérer le clic sur le bouton "Bloquer les créneaux sélectionnés"
            blockButton.addEventListener('click', function() {
                if (selectedSlots.size === 0) {
                    alert("Veuillez sélectionner au moins un créneau.");
                    return;
                }

                selectedSlots.forEach(slotKey => {
                    const [date, time] = slotKey.split(' ');

                    // Vérifier si le créneau est déjà bloqué
                    const isBlocked = blocked_slots.find(slot => slot.date === date && slot.time === time);

                    if (isBlocked) {
                        // Débloquer le créneau
                        blocked_slots = blocked_slots.filter(slot => !(slot.date === date && slot.time === time));
                    } else {
                        // Bloquer le créneau
                        blocked_slots.push({ date, time });
                    }
                });

                // Réinitialiser la sélection
                selectedSlots.clear();
                updateSelectedSlots();

                // Mettre à jour l'affichage
                generateTimeSlots(new Date(weekSelector.value));
                handleTimeSlotSelection();
            });

            // Générer les créneaux horaires pour la semaine sélectionnée
            weekSelector.addEventListener('change', function() {
                const selectedWeekStart = new Date(weekSelector.value);
                generateDaysHeader(selectedWeekStart);
                generateTimeSlots(selectedWeekStart);
                handleTimeSlotSelection();
            });

            // Initialiser les options de semaine et les créneaux horaires
            generateWeekOptions();
            weekSelector.dispatchEvent(new Event('change')); // Générer les créneaux pour la première semaine par défaut
        });

        function goToProfilAdmin() {
            window.location.href = "/profilAdmin"; // Rediriger vers la page du profil de l'admin
        }
    </script>
</body>
</html>